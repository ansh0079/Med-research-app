<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Medical Research Finder - AI Enhanced</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif']
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out',
            'slide-up': 'slideUp 0.3s ease-out'
          },
          keyframes: {
            fadeIn: {
              'from': { opacity: 0, transform: 'translateY(10px)' },
              'to': { opacity: 1, transform: 'translateY(0)' }
            },
            slideUp: {
              'from': { opacity: 0, transform: 'translateY(20px)' },
              'to': { opacity: 1, transform: 'translateY(0)' }
            }
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"/>
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0, #764ba2 100%);
      background-attachment: fixed;
    }
    .gradient-text {
      background: linear-gradient(90deg, #a3bffa, #e2d5f5);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      width: 2.5rem;
      height: 2.5rem;
      animation: spin 1s linear infinite;
    }
    .mini-spinner {
      border: 2px solid rgba(79, 70, 229, 0.3);
      border-radius: 50%;
      border-top-color: #4f46e5;
      width: 1rem;
      height: 1rem;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .article-card {
      transition: all 0.2s ease-in-out;
      background: rgba(255, 255, 255, 0.95);
    }
    .article-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .free-badge { background: linear-gradient(90deg, #059669, #10b981); }
    .citation-badge { background-color: #e0e7ff; color: #4338ca; }
    .cochrane-badge { background: linear-gradient(90deg, #ea580c, #f97316); }
    .trial-badge { background-color: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
    .saved-badge { background: linear-gradient(90deg, #dc2626, #ef4444); }
    .status-recruiting { background-color: #dcfce7; color: #166534; }
    .status-completed { background-color: #dbeafe; color: #1e40af; }
    .status-other { background-color: #f3f4f6; color: #4b5563; }
    .tab-active { background-color: #ffffff !important; color: #4f46e5 !important; }
    
    .modal-overlay {
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
    
    .synopsis-content {
      max-height: 60vh;
      overflow-y: auto;
    }

    .collection-tag {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-block;
      margin: 0.25rem;
    }

    .saved-icon-fill {
      fill: #dc2626;
    }

    .filter-badge {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .filters-panel {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-in-out;
    }
    
    .filters-panel.open {
      max-height: 800px;
    }

    .cors-warning {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      border: 2px solid #d97706;
    }
  </style>
</head>
<body class="h-full">
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;

    /**
     * API CONFIGURATION - WITH CORS PROXY
     */
    // Using AllOrigins proxy for CORS - more reliable than corsproxy
    const USE_CORS_PROXY = true;
    const PUBMED_BASE = 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils';
    const TOOL_NAME = 'medsearch_demo';
    const EMAIL = 'demo@example.com';

    /**
     * STORAGE HELPERS
     */
    const getStoredArticles = () => {
      try {
        return JSON.parse(localStorage.getItem('savedArticles') || '[]');
      } catch {
        return [];
      }
    };

    const getStoredCollections = () => {
      try {
        return JSON.parse(localStorage.getItem('collections') || '[]');
      } catch {
        return [];
      }
    };

    const saveArticlesToStorage = (articles) => {
      localStorage.setItem('savedArticles', JSON.stringify(articles));
    };

    const saveCollectionsToStorage = (collections) => {
      localStorage.setItem('collections', JSON.stringify(collections));
    };

    /**
     * FETCH WITH TIMEOUT AND CORS HANDLING
     */
    const fetchWithTimeout = async (resource, options = {}) => {
      const { timeout = 20000 } = options;
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);

      // Use AllOrigins CORS proxy for better reliability
      let url;
      if (USE_CORS_PROXY) {
        url = `https://api.allorigins.win/raw?url=${encodeURIComponent(resource)}`;
      } else {
        url = resource;
      }

      console.log('Fetching:', url);

      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal  
        });
        clearTimeout(id);
        
        if (!response.ok) {
          console.error('Response not OK:', response.status, response.statusText);
          throw new Error(`HTTP Error ${response.status}: ${response.statusText}`);
        }
        
        console.log('Fetch successful');
        return response;
      } catch (error) {
        clearTimeout(id);
        console.error('Fetch error:', error);
        if (error.name === 'AbortError') {
          throw new Error("Request timed out. Please try again.");
        }
        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
          throw new Error("Network error. Please check your internet connection.");
        }
        throw error;
      }
    };

    /**
     * CLAUDE AI SYNOPSIS
     */
    const generateSynopsis = async (article, pmid, apiKey) => {
      if (!apiKey) {
        throw new Error("Please configure your Anthropic API key in settings.");
      }

      const title = article.title || 'Untitled Article';
      const journal = article.source || '';
      const date = article.pubdate || '';
      
      let authors = 'Unknown';
      if (article.authors?.length > 0) {
        authors = article.authors.slice(0, 3).map(a => a.name).join(', ');
        if (article.authors.length > 3) authors += ', et al.';
      }

      const prompt = `You are a medical research assistant. Analyze this research article and provide a concise, clinically-focused synopsis.

Article Information:
- Title: ${title}
- Authors: ${authors}
- Journal: ${journal}
- Publication Date: ${date}
- PubMed ID: ${pmid}

Please provide a structured synopsis with:

1. **Key Finding** (1-2 sentences): What is the main discovery or conclusion?

2. **Clinical Relevance** (2-3 sentences): Why does this matter for healthcare practice or patient care?

3. **Study Design** (1 sentence): What type of study was this?

4. **Limitations** (1-2 sentences): What are the key limitations to consider?

5. **Bottom Line** (1 sentence): What should a clinician take away from this?

Keep the language clear and professional, suitable for healthcare professionals. Be concise - aim for a total of 150-200 words.`;

      try {
        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-api-key": apiKey,
            "anthropic-version": "2023-06-01"
          },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 1000,
            messages: [{ role: "user", content: prompt }]
          })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          if (response.status === 401) {
            throw new Error("Invalid API key. Please check your Anthropic API key in settings.");
          }
          throw new Error(`Claude API error: ${response.status}`);
        }

        const data = await response.json();
        return data.content[0].text;
      } catch (error) {
        console.error("Synopsis generation error:", error);
        throw error.message.includes("API key") ? error : new Error("Failed to generate synopsis. Please check your API key.");
      }
    };

    /**
     * PUBMED SEARCH WITH ERROR HANDLING
     */
    const searchPubMed = async (query, isCochrane = false, filters = {}) => {
      let finalQuery = query;

      // Apply article type filters
      if (filters.articleTypes && filters.articleTypes.length > 0) {
        const typeQueries = filters.articleTypes.map(type => {
          switch(type) {
            case 'rct': return 'Randomized Controlled Trial[Publication Type]';
            case 'meta': return 'Meta-Analysis[Publication Type]';
            case 'review': return 'Review[Publication Type]';
            case 'systematic': return 'Systematic Review[Publication Type]';
            case 'case': return 'Case Reports[Publication Type]';
            case 'clinical': return 'Clinical Trial[Publication Type]';
            default: return '';
          }
        }).filter(Boolean);
        
        if (typeQueries.length > 0) {
          finalQuery += ` AND (${typeQueries.join(' OR ')})`;
        }
      }

      // Apply date range filter
      if ((filters.dateFrom && filters.dateFrom.trim()) || (filters.dateTo && filters.dateTo.trim())) {
        const fromDate = (filters.dateFrom && filters.dateFrom.trim()) ? filters.dateFrom.replace(/-/g, '/') : '1900/01/01';
        const toDate = (filters.dateTo && filters.dateTo.trim()) ? filters.dateTo.replace(/-/g, '/') : new Date().toISOString().split('T')[0].replace(/-/g, '/');
        finalQuery += ` AND (${fromDate}[PDAT] : ${toDate}[PDAT])`;
      }

      // Apply author filter
      if (filters.author && filters.author.trim()) {
        finalQuery += ` AND ${filters.author.trim()}[Author]`;
      }

      // Apply journal filter
      if (filters.journal && filters.journal.trim()) {
        finalQuery += ` AND ${filters.journal.trim()}[Journal]`;
      }

      // Apply free full-text filter
      if (filters.freeFullText === true) {
        finalQuery += ' AND free full text[sb]';
      }

      // Apply Cochrane filter
      if (isCochrane) {
        finalQuery = `(${finalQuery}) AND "Cochrane Database Syst Rev"[Journal]`;
      }

      const retMax = 50;
      const searchUrl = `${PUBMED_BASE}/esearch.fcgi?db=pubmed&term=${encodeURIComponent(finalQuery)}&retmode=json&retmax=${retMax}&tool=${TOOL_NAME}&email=${EMAIL}`;
      
      console.log('=== PubMed Search ===');
      console.log('Query:', finalQuery);
      console.log('URL:', searchUrl);
      
      const searchRes = await fetchWithTimeout(searchUrl);
      const searchData = await searchRes.json();
      
      console.log('Search response:', searchData);

      const ids = searchData.esearchresult?.idlist || [];
      const total = parseInt(searchData.esearchresult?.count) || 0;
      
      console.log(`Found ${ids.length} IDs, ${total} total results`);

      if (ids.length === 0) return { count: 0, articles: [] };

      const CHUNK_SIZE = 50;
      const allDetails = {};
      
      for (let i = 0; i < ids.length; i += CHUNK_SIZE) {
        const chunk = ids.slice(i, i + CHUNK_SIZE);
        const url = `${PUBMED_BASE}/esummary.fcgi?db=pubmed&id=${chunk.join(',')}&retmode=json&tool=${TOOL_NAME}&email=${EMAIL}`;
        
        try {
          const res = await fetchWithTimeout(url);
          const data = await res.json();
          if (data.result) {
            chunk.forEach(id => { 
              if (id !== 'uids' && data.result[id]) {
                allDetails[id] = data.result[id];
              }
            });
          }
        } catch (e) {
          console.warn("Failed to fetch chunk:", e);
        }
      }

      const articles = ids
        .filter(id => allDetails[id])
        .map(id => ({
          pmid: id,
          data: allDetails[id],
          citations: parseInt(allDetails[id].pmcrefcount) || 0
        }))
        .sort((a, b) => b.citations - a.citations);

      return { count: total, articles };
    };

    /**
     * CLINICAL TRIALS SEARCH
     */
    const searchClinicalTrials = async (query) => {
      const pageSize = 50;
      const url = `https://clinicaltrials.gov/api/v2/studies?query.term=${encodeURIComponent(query)}&pageSize=${pageSize}&sort=Relevance&fields=NCTId,BriefTitle,OverallStatus,Conditions,Interventions,Phase`;
      
      console.log('=== Clinical Trials Search ===');
      console.log('URL:', url);
      
      const res = await fetchWithTimeout(url);
      const data = await res.json();
      
      console.log('Trials response:', data);
      console.log(`Found ${data.studies?.length || 0} trials`);

      return {
        count: data.totalCount || data.studies?.length || 0,
        trials: data.studies || []
      };
    };

    /**
     * SETTINGS MODAL
     */
    const SettingsModal = ({ isOpen, onClose, apiKey, tempApiKey, setTempApiKey, onSave, onClear }) => {
      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" onClick={onClose}>
          <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full animate-slide-up" onClick={(e) => e.stopPropagation()}>
            <div className="p-6 border-b border-gray-200">
              <div className="flex items-center justify-between">
                <h3 className="text-xl font-bold text-gray-900">Settings</h3>
                <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            <div className="p-6 space-y-4">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Anthropic API Key</label>
                <input
                  type="password"
                  value={tempApiKey}
                  onChange={(e) => setTempApiKey(e.target.value)}
                  placeholder="sk-ant-..."
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none font-mono text-sm"
                />
                <p className="mt-2 text-xs text-gray-500">
                  Required for AI synopsis generation. Get your key at{' '}
                  <a href="https://console.anthropic.com" target="_blank" rel="noopener noreferrer" className="text-purple-600 hover:underline">
                    console.anthropic.com
                  </a>
                </p>
              </div>

              {apiKey && (
                <div className="p-3 bg-green-50 border border-green-200 rounded-lg">
                  <p className="text-sm text-green-700 font-medium">✓ API key configured</p>
                </div>
              )}
            </div>

            <div className="p-6 border-t border-gray-200 flex justify-end gap-3">
              {apiKey && (
                <button onClick={onClear} className="px-4 py-2 text-red-600 bg-red-50 hover:bg-red-100 rounded-lg font-medium">
                  Clear Key
                </button>
              )}
              <button onClick={onSave} className="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium">
                Save
              </button>
            </div>
          </div>
        </div>
      );
    };

    /**
     * SYNOPSIS MODAL
     */
    const SynopsisModal = ({ isOpen, onClose, synopsis, isLoading, error, title, onOpenSettings }) => {
      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" onClick={onClose}>
          <div className="bg-white rounded-2xl shadow-2xl max-w-3xl w-full animate-slide-up" onClick={(e) => e.stopPropagation()}>
            <div className="p-6 border-b border-gray-200">
              <div className="flex items-start justify-between gap-4">
                <div className="flex-grow">
                  <h3 className="text-xl font-bold text-gray-900 mb-2">AI Synopsis</h3>
                  <p className="text-sm text-gray-600 leading-relaxed">{title}</p>
                </div>
                <button onClick={onClose} className="text-gray-400 hover:text-gray-600 flex-shrink-0">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            <div className="synopsis-content p-6">
              {isLoading && (
                <div className="flex flex-col items-center justify-center py-8">
                  <div className="spinner mb-4"></div>
                  <p className="text-gray-600">Generating synopsis with Claude...</p>
                </div>
              )}

              {error && (
                <div className="p-4 bg-red-50 border border-red-200 rounded-lg">
                  <p className="text-red-800 font-medium mb-2">{error}</p>
                  {error.includes("API key") && (
                    <button onClick={onOpenSettings} className="text-sm text-red-600 hover:underline">
                      → Configure API key in settings
                    </button>
                  )}
                </div>
              )}

              {!isLoading && !error && synopsis && (
                <div className="prose prose-sm max-w-none">
                  <div className="whitespace-pre-wrap text-gray-700 leading-relaxed" dangerouslySetInnerHTML={{ __html: synopsis.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') }} />
                </div>
              )}
            </div>

            <div className="p-6 border-t border-gray-200 flex justify-end">
              <button onClick={onClose} className="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium">
                Close
              </button>
            </div>
          </div>
        </div>
      );
    };

    /**
     * COLLECTIONS MODAL
     */
    const CollectionsModal = ({ isOpen, onClose, article, pmid, savedArticles, collections, onSave }) => {
      const [selectedCollections, setSelectedCollections] = useState([]);
      const [newCollectionName, setNewCollectionName] = useState('');
      const [showNewCollection, setShowNewCollection] = useState(false);

      useEffect(() => {
        if (isOpen && article) {
          const saved = savedArticles.find(a => a.pmid === pmid);
          setSelectedCollections(saved?.collections || []);
        }
      }, [isOpen, article, pmid, savedArticles]);

      const toggleCollection = (collectionName) => {
        setSelectedCollections(prev => 
          prev.includes(collectionName) 
            ? prev.filter(c => c !== collectionName)
            : [...prev, collectionName]
        );
      };

      const handleCreateCollection = () => {
        if (newCollectionName.trim()) {
          const trimmed = newCollectionName.trim();
          if (!collections.includes(trimmed)) {
            onSave(article, pmid, [...selectedCollections, trimmed], [...collections, trimmed]);
            setSelectedCollections([...selectedCollections, trimmed]);
          }
          setNewCollectionName('');
          setShowNewCollection(false);
        }
      };

      const handleSave = () => {
        onSave(article, pmid, selectedCollections, collections);
        onClose();
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" onClick={onClose}>
          <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full animate-slide-up" onClick={(e) => e.stopPropagation()}>
            <div className="p-6 border-b border-gray-200">
              <div className="flex items-start justify-between">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-purple-100 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" />
                    </svg>
                  </div>
                  <div>
                    <h3 className="text-xl font-bold text-gray-900">Add to Collections</h3>
                    <p className="text-sm text-gray-500 mt-1">Organize this article</p>
                  </div>
                </div>
                <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            <div className="p-6 max-h-96 overflow-y-auto">
              <div className="space-y-3">
                {collections.length === 0 && !showNewCollection && (
                  <p className="text-gray-500 text-center py-4">No collections yet. Create your first one!</p>
                )}
                
                {collections.map(collection => (
                  <label key={collection} className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
                    <input
                      type="checkbox"
                      checked={selectedCollections.includes(collection)}
                      onChange={() => toggleCollection(collection)}
                      className="w-4 h-4 text-purple-600 rounded focus:ring-purple-500"
                    />
                    <span className="flex-grow font-medium text-gray-700">{collection}</span>
                  </label>
                ))}

                {showNewCollection ? (
                  <div className="flex gap-2">
                    <input
                      type="text"
                      value={newCollectionName}
                      onChange={(e) => setNewCollectionName(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && handleCreateCollection()}
                      placeholder="Collection name..."
                      className="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none"
                      autoFocus
                    />
                    <button onClick={handleCreateCollection} className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                      Add
                    </button>
                    <button onClick={() => { setShowNewCollection(false); setNewCollectionName(''); }} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                      Cancel
                    </button>
                  </div>
                ) : (
                  <button onClick={() => setShowNewCollection(true)} className="w-full p-3 border-2 border-dashed border-purple-300 rounded-lg text-purple-600 hover:border-purple-400 hover:bg-purple-50 font-medium flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                    </svg>
                    New Collection
                  </button>
                )}
              </div>
            </div>

            <div className="p-6 border-t border-gray-200 flex justify-end gap-3">
              <button onClick={onClose} className="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium">
                Cancel
              </button>
              <button onClick={handleSave} className="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium">
                Save ({selectedCollections.length})
              </button>
            </div>
          </div>
        </div>
      );
    };

    /**
     * MANAGE COLLECTIONS MODAL
     */
    const ManageCollectionsModal = ({ isOpen, onClose, collections, onRename, onDelete }) => {
      const [editingIndex, setEditingIndex] = useState(-1);
      const [editValue, setEditValue] = useState('');

      const startEdit = (index, name) => {
        setEditingIndex(index);
        setEditValue(name);
      };

      const saveEdit = (oldName) => {
        if (editValue.trim() && editValue !== oldName) {
          onRename(oldName, editValue.trim());
        }
        setEditingIndex(-1);
        setEditValue('');
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" onClick={onClose}>
          <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full animate-slide-up" onClick={(e) => e.stopPropagation()}>
            <div className="p-6 border-b border-gray-200">
              <div className="flex items-start justify-between">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-purple-100 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                    </svg>
                  </div>
                  <div>
                    <h3 className="text-xl font-bold text-gray-900">Manage Collections</h3>
                    <p className="text-sm text-gray-500 mt-1">{collections.length} collection{collections.length !== 1 ? 's' : ''}</p>
                  </div>
                </div>
                <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            <div className="p-6 max-h-96 overflow-y-auto">
              {collections.length === 0 ? (
                <p className="text-gray-500 text-center py-4">No collections yet</p>
              ) : (
                <div className="space-y-2">
                  {collections.map((collection, index) => (
                    <div key={collection} className="flex items-center gap-2 p-3 bg-gray-50 rounded-lg">
                      {editingIndex === index ? (
                        <>
                          <input
                            type="text"
                            value={editValue}
                            onChange={(e) => setEditValue(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && saveEdit(collection)}
                            className="flex-grow px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 outline-none"
                            autoFocus
                          />
                          <button onClick={() => saveEdit(collection)} className="px-3 py-1 bg-purple-600 text-white text-sm rounded hover:bg-purple-700">
                            Save
                          </button>
                          <button onClick={() => setEditingIndex(-1)} className="px-3 py-1 bg-gray-200 text-gray-700 text-sm rounded hover:bg-gray-300">
                            Cancel
                          </button>
                        </>
                      ) : (
                        <>
                          <span className="flex-grow font-medium text-gray-700">{collection}</span>
                          <button onClick={() => startEdit(index, collection)} className="p-1 text-gray-400 hover:text-purple-600" title="Rename">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                          </button>
                          <button onClick={() => onDelete(collection)} className="p-1 text-gray-400 hover:text-red-600" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                          </button>
                        </>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>

            <div className="p-6 border-t border-gray-200 flex justify-end">
              <button onClick={onClose} className="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium">
                Close
              </button>
            </div>
          </div>
        </div>
      );
    };

    /**
     * PUBMED CARD
     */
    const PubMedCard = ({ article, pmid, isCochrane, isSaved, savedCollections, onAnalyze, onToggleSave }) => {
      const [analyzing, setAnalyzing] = useState(false);

      const title = article.title || 'No title';
      const journal = article.source || article.fulljournalname || 'Unknown Journal';
      const date = article.pubdate || article.epubdate || '';

      let authorText = 'No authors listed';
      if (article.authors?.length > 0) {
        const names = article.authors.map(a => a.name);
        authorText = names.length > 3 ? `${names.slice(0, 3).join(', ')}, et al.` : names.join(', ');
      }

      let isFree = false, pmcID = '', doi = '';
      if (article.articleids) {
        article.articleids.forEach(id => {
          if (id.idtype === 'pmc') { isFree = true; pmcID = id.value; }
          if (id.idtype === 'doi') doi = id.value;
        });
      }

      const citations = article.pmcrefcount ? parseInt(article.pmcrefcount) : 0;
      const pubmedURL = `https://pubmed.ncbi.nlm.nih.gov/${pmid}/`;
      const fullTextURL = pmcID ? `https://www.ncbi.nlm.nih.gov/pmc/articles/${pmcID}/` : (doi ? `https://doi.org/${doi}` : pubmedURL);

      const handleAnalyze = async () => {
        setAnalyzing(true);
        await onAnalyze(article, pmid, title);
        setAnalyzing(false);
      };

      return (
        <article className={`article-card rounded-xl p-5 shadow-sm text-slate-800 flex flex-col gap-3 animate-fade-in ${isFree ? '!bg-emerald-50 border !border-emerald-300' : ''}`}>
          <div className="flex flex-col gap-1">
            <div className="flex flex-wrap gap-2 mb-1 items-center">
              {isCochrane && <span className="cochrane-badge text-xs font-bold text-white px-2 py-0.5 rounded-full uppercase tracking-wider shadow-sm">Cochrane</span>}
              {isFree && <span className="free-badge text-xs font-bold text-white px-2 py-0.5 rounded-full uppercase tracking-wider shadow-sm">Free Full Text</span>}
              {citations > 0 && <span className="citation-badge text-xs font-bold px-2 py-0.5 rounded-full">Cited by {citations}</span>}
              {isSaved && <span className="saved-badge text-xs font-bold text-white px-2 py-0.5 rounded-full uppercase tracking-wider shadow-sm">Saved</span>}
              <button onClick={() => onToggleSave(article, pmid)} className="ml-auto p-1 hover:bg-gray-200 rounded-full" title={isSaved ? "Remove from saved" : "Save article"}>
                <svg xmlns="http://www.w3.org/2000/svg" className={`h-5 w-5 ${isSaved ? 'saved-icon-fill' : 'text-gray-400'}`} fill={isSaved ? "currentColor" : "none"} viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                </svg>
              </button>
            </div>
            {savedCollections.length > 0 && (
              <div className="flex flex-wrap gap-1 mb-2">
                {savedCollections.map(col => (
                  <span key={col} className="collection-tag">{col}</span>
                ))}
              </div>
            )}
            <h2 className="text-lg md:text-xl font-bold leading-tight text-indigo-900 hover:text-indigo-700">
              <a href={pubmedURL} target="_blank" rel="noopener noreferrer">{title}</a>
            </h2>
          </div>
          <div className="text-sm text-slate-600">
            <p className="font-medium mb-1">{authorText}</p>
            <p className="opacity-90"><span className="italic font-semibold">{journal}</span>{date && ` • ${date}`}</p>
          </div>
          <div className={`mt-auto pt-3 flex flex-wrap gap-3 items-center border-t ${isFree ? 'border-emerald-200' : 'border-slate-100'}`}>
            <a href={pubmedURL} target="_blank" rel="noopener noreferrer" className="text-indigo-700 font-semibold text-sm hover:underline">
              View on PubMed ↗
            </a>
            {(isFree || doi) && (
              <a href={fullTextURL} target="_blank" rel="noopener noreferrer" className={`${isFree ? 'text-emerald-700' : 'text-indigo-700'} font-semibold text-sm hover:underline`}>
                {isFree ? 'Read Full Text ↗' : 'Publisher ↗'}
              </a>
            )}
            <button onClick={handleAnalyze} disabled={analyzing}
              className="ml-auto flex items-center gap-2 px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold rounded-lg disabled:opacity-75">
              {analyzing ? <><div className="mini-spinner"></div><span>Analyzing...</span></> : <><svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg><span>AI Synopsis</span></>}
            </button>
          </div>
        </article>
      );
    };

    /**
     * TRIAL CARD
     */
    const TrialCard = ({ study }) => {
      const m = study.protocolSection;
      const idMod = m.identificationModule;
      const statusMod = m.statusModule;
      const condMod = m.conditionsModule;
      const designMod = m.designModule; 
      
      const nctId = idMod.nctId;
      const title = idMod.briefTitle;
      const status = statusMod.overallStatus || 'Unknown';
      const conditions = condMod?.conditions ? condMod.conditions.slice(0, 3).join(', ') : 'Not listed';
      const phases = designMod?.phases ? designMod.phases.join(', ') : 'Not listed';

      let statusClass = 'status-other';
      if (status === 'RECRUITING') statusClass = 'status-recruiting';
      if (status === 'COMPLETED') statusClass = 'status-completed';

      const trialURL = `https://clinicaltrials.gov/study/${nctId}`;

      return (
        <article className="article-card rounded-xl p-5 shadow-sm text-slate-800 flex flex-col gap-3 animate-fade-in">
          <div className="flex flex-col gap-1">
            <div className="flex flex-wrap gap-2 mb-1">
              <span className={`text-xs font-bold px-2 py-0.5 rounded-full uppercase tracking-wider shadow-sm ${statusClass}`}>{status}</span>
              <span className="trial-badge text-xs font-bold px-2 py-0.5 rounded-full">Trial {nctId}</span>
            </div>
            <h2 className="text-lg md:text-xl font-bold leading-tight text-indigo-900 hover:text-indigo-700">
              <a href={trialURL} target="_blank" rel="noopener noreferrer">{title}</a>
            </h2>
          </div>
          <div className="text-sm text-slate-600 grid grid-cols-1 md:grid-cols-2 gap-2">
            <p><span className="font-semibold">Conditions:</span> {conditions}</p>
            <p><span className="font-semibold">Phase:</span> {phases}</p>
          </div>
          <div className="mt-auto pt-3 flex items-center border-t border-slate-100">
            <a href={trialURL} target="_blank" rel="noopener noreferrer" className="text-indigo-700 font-semibold text-sm hover:underline">
              View on ClinicalTrials.gov ↗
            </a>
          </div>
        </article>
      );
    };

    /**
     * PAGINATION
     */
    const Pagination = ({ currentPage, totalPages, onPageChange }) => {
      if (totalPages <= 1) return null;

      return (
        <nav className="py-8 flex justify-center gap-2">
          <button onClick={() => onPageChange(currentPage - 1)} disabled={currentPage === 1}
            className={`px-4 py-2 rounded-lg font-medium bg-indigo-900/40 text-indigo-100 hover:bg-indigo-900/60 ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}`}>
            ←
          </button>
          <span className="px-4 py-2 text-indigo-100">Page {currentPage} / {totalPages}</span>
          <button onClick={() => onPageChange(currentPage + 1)} disabled={currentPage >= totalPages}
            className={`px-4 py-2 rounded-lg font-medium bg-indigo-900/40 text-indigo-100 hover:bg-indigo-900/60 ${currentPage >= totalPages ? 'opacity-50 cursor-not-allowed' : ''}`}>
            →
          </button>
        </nav>
      );
    };

    /**
     * MAIN APP
     */
    function MedicalResearchFinder() {
      const [view, setView] = useState('search');
      const [source, setSource] = useState('pubmed');
      const [query, setQuery] = useState('');
      const [searchQuery, setSearchQuery] = useState('');
      const [currentPage, setCurrentPage] = useState(1);
      const [articles, setArticles] = useState([]);
      const [totalAvailable, setTotalAvailable] = useState(0);
      const [isLoading, setIsLoading] = useState(false);
      const [loadingText, setLoadingText] = useState('');
      const [error, setError] = useState('');
      
      const [showFilters, setShowFilters] = useState(false);
      const [filters, setFilters] = useState({
        dateRange: 'all',
        dateFrom: '',
        dateTo: '',
        articleTypes: [],
        freeFullText: false,
        author: '',
        journal: ''
      });
      
      const [showSynopsis, setShowSynopsis] = useState(false);
      const [currentSynopsis, setCurrentSynopsis] = useState('');
      const [synopsisLoading, setSynopsisLoading] = useState(false);
      const [synopsisError, setSynopsisError] = useState('');
      const [synopsisTitle, setSynopsisTitle] = useState('');

      const [showSettings, setShowSettings] = useState(false);
      const [apiKey, setApiKey] = useState(() => localStorage.getItem('anthropic_api_key') || '');
      const [tempApiKey, setTempApiKey] = useState('');

      const [savedArticles, setSavedArticles] = useState(() => getStoredArticles());
      const [collections, setCollections] = useState(() => getStoredCollections());
      const [showCollectionsModal, setShowCollectionsModal] = useState(false);
      const [showManageCollections, setShowManageCollections] = useState(false);
      const [currentArticleForCollection, setCurrentArticleForCollection] = useState(null);
      const [currentPmidForCollection, setCurrentPmidForCollection] = useState('');
      const [selectedCollection, setSelectedCollection] = useState('all');

      const resultsPerPage = 15;

      const activeFiltersCount = 
        (filters.dateRange !== 'all' ? 1 : 0) +
        filters.articleTypes.length +
        (filters.freeFullText ? 1 : 0) +
        (filters.author.trim() ? 1 : 0) +
        (filters.journal.trim() ? 1 : 0);

      const updateDateRange = (range) => {
        const today = new Date();
        let fromDate = '';
        
        switch(range) {
          case '1year':
            fromDate = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate()).toISOString().split('T')[0];
            break;
          case '5years':
            fromDate = new Date(today.getFullYear() - 5, today.getMonth(), today.getDate()).toISOString().split('T')[0];
            break;
          case '10years':
            fromDate = new Date(today.getFullYear() - 10, today.getMonth(), today.getDate()).toISOString().split('T')[0];
            break;
          case 'custom':
            return;
          default:
            fromDate = '';
        }
        
        setFilters(prev => ({ 
          ...prev, 
          dateRange: range, 
          dateFrom: fromDate,
          dateTo: range === 'all' ? '' : today.toISOString().split('T')[0]
        }));
      };

      const clearFilters = () => {
        setFilters({
          dateRange: 'all',
          dateFrom: '',
          dateTo: '',
          articleTypes: [],
          freeFullText: false,
          author: '',
          journal: ''
        });
      };

      const toggleArticleType = (type) => {
        setFilters(prev => ({
          ...prev,
          articleTypes: prev.articleTypes.includes(type)
            ? prev.articleTypes.filter(t => t !== type)
            : [...prev.articleTypes, type]
        }));
      };

      const handleSourceSwitch = (newSource) => {
        setSource(newSource);
        if (searchQuery) {
          setCurrentPage(1);
          performSearch(searchQuery, newSource);
        }
      };

      const performSearch = async (q, selectedSource = source) => {
        setIsLoading(true);
        setError('');
        setArticles([]);
        setLoadingText(`Searching ${selectedSource === 'pubmed' ? 'PubMed' : selectedSource === 'cochrane' ? 'Cochrane' : 'ClinicalTrials.gov'}...`);

        try {
          if (selectedSource === 'trials') {
            const data = await searchClinicalTrials(q);
            setTotalAvailable(data.count);
            setArticles(data.trials);
          } else {
            setLoadingText('Fetching articles...');
            const hasActiveFilters = filters.dateRange !== 'all' || 
                                     filters.articleTypes.length > 0 || 
                                     filters.freeFullText || 
                                     filters.author.trim() || 
                                     filters.journal.trim();
            
            const data = hasActiveFilters 
              ? await searchPubMed(q, selectedSource === 'cochrane', filters)
              : await searchPubMed(q, selectedSource === 'cochrane', {});
            
            setTotalAvailable(data.count);
            setArticles(data.articles);
          }
        } catch (err) {
          console.error('Search error:', err);
          setError(err.message || 'An unexpected error occurred. Please try again.');
        } finally {
          setIsLoading(false);
        }
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!query.trim()) return;
        setSearchQuery(query);
        setCurrentPage(1);
        setView('search');
        performSearch(query);
      };

      const handleApplyFilters = () => {
        if (searchQuery) {
          setCurrentPage(1);
          performSearch(searchQuery);
        }
      };

      const handleAnalyze = async (article, pmid, title) => {
        setSynopsisTitle(title);
        setShowSynopsis(true);
        setSynopsisLoading(true);
        setSynopsisError('');
        setCurrentSynopsis('');

        try {
          const synopsis = await generateSynopsis(article, pmid, apiKey);
          setCurrentSynopsis(synopsis);
        } catch (err) {
          console.error('Synopsis error:', err);
          setSynopsisError(err.message);
        } finally {
          setSynopsisLoading(false);
        }
      };

      const handleToggleSave = (article, pmid) => {
        const existingIndex = savedArticles.findIndex(a => a.pmid === pmid);
        
        if (existingIndex !== -1) {
          const updated = savedArticles.filter(a => a.pmid !== pmid);
          setSavedArticles(updated);
          saveArticlesToStorage(updated);
        } else {
          setCurrentArticleForCollection(article);
          setCurrentPmidForCollection(pmid);
          setShowCollectionsModal(true);
        }
      };

      const handleSaveToCollections = (article, pmid, selectedCollections, updatedCollections) => {
        const newArticle = {
          ...article,
          pmid: pmid,
          collections: selectedCollections,
          savedAt: new Date().toISOString()
        };

        const existingIndex = savedArticles.findIndex(a => a.pmid === pmid);
        let updated;
        
        if (existingIndex !== -1) {
          updated = [...savedArticles];
          updated[existingIndex] = newArticle;
        } else {
          updated = [newArticle, ...savedArticles];
        }

        setSavedArticles(updated);
        saveArticlesToStorage(updated);
        setCollections(updatedCollections);
        saveCollectionsToStorage(updatedCollections);
      };

      const handleRenameCollection = (oldName, newName) => {
        const updatedCollections = collections.map(c => c === oldName ? newName : c);
        setCollections(updatedCollections);
        saveCollectionsToStorage(updatedCollections);

        const updatedArticles = savedArticles.map(article => ({
          ...article,
          collections: article.collections.map(c => c === oldName ? newName : c)
        }));
        setSavedArticles(updatedArticles);
        saveArticlesToStorage(updatedArticles);

        if (selectedCollection === oldName) {
          setSelectedCollection(newName);
        }
      };

      const handleDeleteCollection = (collectionName) => {
        if (!confirm(`Delete collection "${collectionName}"? Articles will remain saved.`)) return;

        const updatedCollections = collections.filter(c => c !== collectionName);
        setCollections(updatedCollections);
        saveCollectionsToStorage(updatedCollections);

        const updatedArticles = savedArticles.map(article => ({
          ...article,
          collections: article.collections.filter(c => c !== collectionName)
        }));
        setSavedArticles(updatedArticles);
        saveArticlesToStorage(updatedArticles);

        if (selectedCollection === collectionName) {
          setSelectedCollection('all');
        }
      };

      const handleExportSaved = () => {
        if (filteredSavedArticles.length === 0) return;

        const csvRows = [];
        csvRows.push(['Title', 'Authors', 'Journal', 'Date', 'PMID', 'Collections', 'PubMed URL'].join(','));

        filteredSavedArticles.forEach(article => {
          const title = `"${(article.title || '').replace(/"/g, '""')}"`;
          const authors = article.authors?.length > 0 
            ? `"${article.authors.map(a => a.name).join('; ').replace(/"/g, '""')}"` 
            : '""';
          const journal = `"${(article.source || article.fulljournalname || '').replace(/"/g, '""')}"`;
          const date = article.pubdate || article.epubdate || '';
          const pmid = article.pmid;
          const collections = `"${article.collections.join('; ')}"`;
          const url = `https://pubmed.ncbi.nlm.nih.gov/${pmid}/`;
          
          csvRows.push([title, authors, journal, date, pmid, collections, url].join(','));
        });

        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `saved-articles-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      };

      const isSaved = (pmid) => savedArticles.some(a => a.pmid === pmid);
      const getSavedCollections = (pmid) => savedArticles.find(a => a.pmid === pmid)?.collections || [];

      const filteredSavedArticles = selectedCollection === 'all'
        ? savedArticles
        : savedArticles.filter(a => a.collections.includes(selectedCollection));

      const currentItems = view === 'saved' ? filteredSavedArticles : articles;
      const totalPages = Math.ceil(currentItems.length / resultsPerPage);
      const startIndex = (currentPage - 1) * resultsPerPage;
      const pageItems = currentItems.slice(startIndex, startIndex + resultsPerPage);

      const handlePageChange = (page) => {
        setCurrentPage(page);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };

      return (
        <div className="min-h-screen flex flex-col p-4 md:p-8">
          <header className="w-full max-w-4xl mx-auto mb-8">
            <div className="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
              <h1 className="text-3xl md:text-5xl font-extrabold gradient-text text-center md:text-left">
                🔬 Medical Research Finder
              </h1>
              <button onClick={() => { setTempApiKey(apiKey); setShowSettings(true); }}
                className="flex items-center gap-2 px-4 py-2 bg-white/20 hover:bg-white/30 backdrop-blur-md text-white font-semibold rounded-xl border border-white/30">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.350 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Settings
              </button>
            </div>

            <form onSubmit={handleSubmit} className="w-full">
              <div className="relative">
                <input
                  type="text"
                  placeholder="Search medical research... (e.g., 'diabetes treatment', 'COPD exacerbation')"
                  value={query}
                  onChange={(e) => setQuery(e.target.value)}
                  className="w-full pl-12 pr-4 py-4 text-lg rounded-2xl border-2 border-white/30 bg-white/95 backdrop-blur-md shadow-lg focus:outline-none focus:ring-4 focus:ring-purple-300 focus:border-purple-400"
                />
                <svg xmlns="http://www.w3.org/2000/svg" className="absolute left-4 top-1/2 transform -translate-y-1/2 h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
              <div className="flex flex-wrap gap-3 mt-4">
                <button type="submit" className="px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold rounded-xl shadow-lg">
                  Search
                </button>
                <button type="button" onClick={() => setShowFilters(!showFilters)}
                  className={`px-6 py-3 font-bold rounded-xl shadow-lg flex items-center gap-2 ${activeFiltersCount > 0 ? 'bg-blue-600 text-white' : 'bg-white/90 text-gray-700 hover:bg-white'}`}>
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                  </svg>
                  Filters {activeFiltersCount > 0 && `(${activeFiltersCount})`}
                </button>
                <button type="button" onClick={() => { setView('saved'); setCurrentPage(1); }}
                  className={`px-6 py-3 font-bold rounded-xl shadow-lg flex items-center gap-2 ${view === 'saved' ? 'bg-red-600 text-white' : 'bg-white/90 text-gray-700 hover:bg-white'}`}>
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                  </svg>
                  Saved ({savedArticles.length})
                </button>
              </div>

              <div className={`filters-panel ${showFilters ? 'open' : ''}`}>
                <div className="mt-4 p-5 bg-white/95 backdrop-blur-md rounded-xl shadow-lg border border-purple-200">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Date Range</label>
                      <select 
                        value={filters.dateRange}
                        onChange={(e) => updateDateRange(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none">
                        <option value="all">All Time</option>
                        <option value="1year">Last Year</option>
                        <option value="5years">Last 5 Years</option>
                        <option value="10years">Last 10 Years</option>
                        <option value="custom">Custom Range</option>
                      </select>
                      {filters.dateRange === 'custom' && (
                        <div className="mt-2 flex gap-2">
                          <input
                            type="date"
                            value={filters.dateFrom}
                            onChange={(e) => setFilters(prev => ({ ...prev, dateFrom: e.target.value }))}
                            className="flex-1 px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 outline-none text-sm"
                            placeholder="From"
                          />
                          <input
                            type="date"
                            value={filters.dateTo}
                            onChange={(e) => setFilters(prev => ({ ...prev, dateTo: e.target.value }))}
                            className="flex-1 px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 outline-none text-sm"
                            placeholder="To"
                          />
                        </div>
                      )}
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Author</label>
                      <input
                        type="text"
                        value={filters.author}
                        onChange={(e) => setFilters(prev => ({ ...prev, author: e.target.value }))}
                        placeholder="e.g., Smith J"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Journal</label>
                      <input
                        type="text"
                        value={filters.journal}
                        onChange={(e) => setFilters(prev => ({ ...prev, journal: e.target.value }))}
                        placeholder="e.g., Lancet"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none"
                      />
                    </div>

                    <div className="flex items-center">
                      <label className="flex items-center gap-2 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={filters.freeFullText}
                          onChange={(e) => setFilters(prev => ({ ...prev, freeFullText: e.target.checked }))}
                          className="w-4 h-4 text-purple-600 rounded focus:ring-purple-500"
                        />
                        <span className="text-sm font-semibold text-gray-700">Free Full Text Only</span>
                      </label>
                    </div>
                  </div>

                  <div className="mt-4">
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Article Types</label>
                    <div className="flex flex-wrap gap-2">
                      {[
                        { value: 'rct', label: 'RCT' },
                        { value: 'meta', label: 'Meta-Analysis' },
                        { value: 'systematic', label: 'Systematic Review' },
                        { value: 'review', label: 'Review' },
                        { value: 'clinical', label: 'Clinical Trial' },
                        { value: 'case', label: 'Case Report' }
                      ].map(type => (
                        <button
                          key={type.value}
                          type="button"
                          onClick={() => toggleArticleType(type.value)}
                          className={`px-3 py-1.5 text-sm font-medium rounded-lg ${
                            filters.articleTypes.includes(type.value)
                              ? 'bg-purple-600 text-white'
                              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                          }`}>
                          {type.label}
                        </button>
                      ))}
                    </div>
                  </div>

                  <div className="mt-4 flex gap-3">
                    <button type="button" onClick={handleApplyFilters}
                      className="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg">
                      Apply Filters
                    </button>
                    {activeFiltersCount > 0 && (
                      <button type="button" onClick={() => { clearFilters(); if (searchQuery) setTimeout(() => performSearch(searchQuery), 100); }}
                        className="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-lg">
                        Clear All
                      </button>
                    )}
                  </div>
                </div>
              </div>
            </form>
          </header>

          <main className="w-full max-w-6xl mx-auto flex-grow flex flex-col gap-6">
            <section className="w-full max-w-4xl">
              {view === 'search' && (
                <>
                  <div className="flex flex-wrap gap-2 mb-6">
                    <button onClick={() => handleSourceSwitch('pubmed')}
                      className={`px-6 py-3 font-bold rounded-xl shadow-lg ${source === 'pubmed' ? 'tab-active shadow-xl' : 'bg-white/50 text-white hover:bg-white/70 hover:text-purple-600'}`}>
                      PubMed
                    </button>
                    <button onClick={() => handleSourceSwitch('cochrane')}
                      className={`px-6 py-3 font-bold rounded-xl shadow-lg ${source === 'cochrane' ? 'tab-active shadow-xl' : 'bg-white/50 text-white hover:bg-white/70 hover:text-purple-600'}`}>
                      Cochrane Reviews
                    </button>
                    <button onClick={() => handleSourceSwitch('trials')}
                      className={`px-6 py-3 font-bold rounded-xl shadow-lg ${source === 'trials' ? 'tab-active shadow-xl' : 'bg-white/50 text-white hover:bg-white/70 hover:text-purple-600'}`}>
                      Clinical Trials
                    </button>
                  </div>

                  {activeFiltersCount > 0 && (
                    <div className="mb-4 p-4 bg-white/10 backdrop-blur-md rounded-xl border border-white/20">
                      <div className="flex items-center justify-between flex-wrap gap-2">
                        <span className="text-white font-semibold">Active Filters:</span>
                        <div className="flex flex-wrap gap-2">
                          {filters.dateRange !== 'all' && (
                            <span className="filter-badge">
                              📅 {filters.dateRange === '1year' ? 'Last Year' : filters.dateRange === '5years' ? 'Last 5 Years' : filters.dateRange === '10years' ? 'Last 10 Years' : 'Custom Range'}
                              <button onClick={() => { updateDateRange('all'); setTimeout(() => performSearch(searchQuery), 100); }} className="ml-1 hover:text-red-200">×</button>
                            </span>
                          )}
                          {filters.articleTypes.map(type => (
                            <span key={type} className="filter-badge">
                              📄 {type.toUpperCase()}
                              <button onClick={() => { toggleArticleType(type); setTimeout(() => performSearch(searchQuery), 100); }} className="ml-1 hover:text-red-200">×</button>
                            </span>
                          ))}
                          {filters.freeFullText && (
                            <span className="filter-badge">
                              🆓 Free Full Text
                              <button onClick={() => { setFilters(prev => ({ ...prev, freeFullText: false })); setTimeout(() => performSearch(searchQuery), 100); }} className="ml-1 hover:text-red-200">×</button>
                            </span>
                          )}
                          {filters.author && (
                            <span className="filter-badge">
                              👤 {filters.author}
                              <button onClick={() => { setFilters(prev => ({ ...prev, author: '' })); setTimeout(() => performSearch(searchQuery), 100); }} className="ml-1 hover:text-red-200">×</button>
                            </span>
                          )}
                          {filters.journal && (
                            <span className="filter-badge">
                              📚 {filters.journal}
                              <button onClick={() => { setFilters(prev => ({ ...prev, journal: '' })); setTimeout(() => performSearch(searchQuery), 100); }} className="ml-1 hover:text-red-200">×</button>
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                  )}

                  {articles.length > 0 && (
                    <div className="p-3 bg-white/10 backdrop-blur-md rounded-xl border border-white/20 flex flex-wrap justify-between gap-4 items-center text-white text-sm">
                      <div className="font-medium opacity-90">
                        {source === 'pubmed' && 'Top 50 sorted by Citation Count'}
                        {source === 'cochrane' && 'Cochrane Reviews (Top 50 by Citations)'}
                        {source === 'trials' && 'Most Relevant Clinical Trials (Top 50)'}
                      </div>
                      <span className="font-semibold bg-indigo-900/30 px-3 py-1 rounded-full">{totalAvailable.toLocaleString()} total</span>
                    </div>
                  )}
                </>
              )}

              {view === 'saved' && (
                <div className="p-4 bg-white/10 backdrop-blur-md rounded-xl border border-white/20 space-y-3">
                  <div className="flex flex-wrap justify-between items-center gap-3">
                    <div className="flex items-center gap-2 text-white">
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                      </svg>
                      <span className="font-semibold">{filteredSavedArticles.length} article{filteredSavedArticles.length !== 1 ? 's' : ''}</span>
                    </div>
                    <div className="flex gap-2">
                      <button onClick={() => setShowManageCollections(true)} className="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                        </svg>
                        Manage ({collections.length})
                      </button>
                      {filteredSavedArticles.length > 0 && (
                        <button onClick={handleExportSaved} className="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-lg flex items-center gap-2">
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                          </svg>
                          Export CSV
                        </button>
                      )}
                    </div>
                  </div>
                  
                  {collections.length > 0 && (
                    <div className="flex flex-wrap gap-2">
                      <button onClick={() => { setSelectedCollection('all'); setCurrentPage(1); }}
                        className={`px-3 py-1.5 text-sm font-medium rounded-lg ${selectedCollection === 'all' ? 'bg-white text-purple-600' : 'bg-white/20 text-white hover:bg-white/30'}`}>
                        All ({savedArticles.length})
                      </button>
                      {collections.map(col => {
                        const count = savedArticles.filter(a => a.collections.includes(col)).length;
                        return (
                          <button key={col} onClick={() => { setSelectedCollection(col); setCurrentPage(1); }}
                            className={`px-3 py-1.5 text-sm font-medium rounded-lg ${selectedCollection === col ? 'bg-white text-purple-600' : 'bg-white/20 text-white hover:bg-white/30'}`}>
                            {col} ({count})
                          </button>
                        );
                      })}
                    </div>
                  )}
                </div>
              )}
            </section>

            <section className="w-full max-w-4xl flex-grow flex flex-col">
              {view === 'search' && isLoading && (
                <div className="flex flex-col items-center justify-center py-12">
                  <div className="spinner mb-4"></div>
                  <p className="text-indigo-100 font-medium animate-pulse">{loadingText}</p>
                </div>
              )}

              {view === 'search' && error && (
                <div className="p-5 mb-6 cors-warning backdrop-blur rounded-xl text-gray-900">
                  <p className="font-bold text-lg mb-2">⚠️ Search Error</p>
                  <p className="mb-3">{error}</p>
                  <div className="text-sm bg-white/70 p-3 rounded-lg">
                    <p className="font-semibold mb-2">💡 Quick Fix:</p>
                    <p>This app needs to make direct API calls. If searches aren't working, try:</p>
                    <ol className="list-decimal ml-5 mt-2 space-y-1">
                      <li>Refresh the page and try again</li>
                      <li>Check your internet connection</li>
                      <li>Disable browser extensions that might block requests</li>
                      <li>Try a different search term</li>
                    </ol>
                  </div>
                </div>
              )}

              {view === 'search' && !isLoading && articles.length === 0 && searchQuery && !error && (
                <div className="text-center bg-white/10 backdrop-blur-md rounded-xl p-8 text-white border border-white/20">
                  <p className="text-xl font-semibold">No results found</p>
                  <p className="text-indigo-200 mt-2">Try adjusting your search terms or filters</p>
                </div>
              )}

              {view === 'saved' && filteredSavedArticles.length === 0 && (
                <div className="text-center bg-white/10 backdrop-blur-md rounded-xl p-8 text-white border border-white/20">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-16 w-16 mx-auto mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                  </svg>
                  <p className="text-xl font-semibold mb-2">No saved articles yet</p>
                  <p className="text-indigo-200">Click the bookmark icon on articles to save them</p>
                </div>
              )}

              {((view === 'search' && !isLoading && articles.length > 0) || (view === 'saved' && filteredSavedArticles.length > 0)) && (
                <>
                  <div className="flex flex-col gap-4">
                    {view === 'search' && source === 'trials' ? (
                      pageItems.map((study, idx) => <TrialCard key={`trial-${idx}`} study={study} />)
                    ) : view === 'search' ? (
                      pageItems.map(({ pmid, data }) => (
                        <PubMedCard 
                          key={pmid} 
                          article={data} 
                          pmid={pmid} 
                          isCochrane={source === 'cochrane'} 
                          isSaved={isSaved(pmid)}
                          savedCollections={getSavedCollections(pmid)}
                          onAnalyze={handleAnalyze}
                          onToggleSave={handleToggleSave}
                        />
                      ))
                    ) : (
                      pageItems.map(saved => (
                        <PubMedCard 
                          key={saved.pmid} 
                          article={saved} 
                          pmid={saved.pmid} 
                          isCochrane={false}
                          isSaved={true}
                          savedCollections={saved.collections}
                          onAnalyze={handleAnalyze}
                          onToggleSave={handleToggleSave}
                        />
                      ))
                    )}
                  </div>
                  <Pagination currentPage={currentPage} totalPages={totalPages} onPageChange={handlePageChange} />
                </>
              )}
            </section>
          </main>

          <footer className="w-full py-6 text-center text-indigo-200 text-sm bg-black/10 mt-8">
            <p>Data: PubMed, Cochrane, ClinicalTrials.gov • AI: Claude • For education only</p>
          </footer>

          <SettingsModal
            isOpen={showSettings}
            onClose={() => setShowSettings(false)}
            apiKey={apiKey}
            tempApiKey={tempApiKey}
            setTempApiKey={setTempApiKey}
            onSave={() => { setApiKey(tempApiKey); localStorage.setItem('anthropic_api_key', tempApiKey); setShowSettings(false); }}
            onClear={() => { setApiKey(''); setTempApiKey(''); localStorage.removeItem('anthropic_api_key'); }}
          />

          <SynopsisModal
            isOpen={showSynopsis}
            onClose={() => { setShowSynopsis(false); setCurrentSynopsis(''); setSynopsisError(''); }}
            synopsis={currentSynopsis}
            isLoading={synopsisLoading}
            error={synopsisError}
            title={synopsisTitle}
            onOpenSettings={() => { setShowSynopsis(false); setTempApiKey(apiKey); setShowSettings(true); }}
          />

          <CollectionsModal
            isOpen={showCollectionsModal}
            onClose={() => { setShowCollectionsModal(false); setCurrentArticleForCollection(null); setCurrentPmidForCollection(''); }}
            article={currentArticleForCollection}
            pmid={currentPmidForCollection}
            savedArticles={savedArticles}
            collections={collections}
            onSave={handleSaveToCollections}
          />

          <ManageCollectionsModal
            isOpen={showManageCollections}
            onClose={() => setShowManageCollections(false)}
            collections={collections}
            onRename={handleRenameCollection}
            onDelete={handleDeleteCollection}
          />
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<MedicalResearchFinder />);
  </script>
</body>
</html>
